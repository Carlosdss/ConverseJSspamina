{"version":3,"sources":["../src/utils.js"],"names":["root","factory","define","sizzle","Promise","jQBrowser","_","locales","moment","Strophe","b64_sha1","SHA1","URL_REGEX","logger","assign","get","console","log","bind","noop","afterAnimationEnd","el","callback","classList","remove","isFunction","unescapeHTML","htmlEscapedText","div","document","createElement","innerHTML","innerText","isImage","url","resolve","reject","img","Image","timer","window","setTimeout","Error","onerror","onabort","clearTimeout","onload","src","calculateSlideStep","height","calculateElementHeight","reduce","children","result","child","offsetHeight","slideOutWrapup","removeAttribute","style","overflow","u","__","str","isUndefined","Jed","isConverseLocale","locale","sprintf","apply","arguments","jed","JSON","parse","t","translate","length","fetch","slice","call","___","isLocaleAvailable","available","sublocale","split","addHyperlinks","text","list","match","links","each","prot","indexOf","encodeURI","decodeURI","replace","escape","a","push","pop","renderImageURLs","obj","textContent","forEach","then","className","anchors","outerHTML","slideInAllElements","elements","all","map","partial","slideIn","slideToggleElement","includes","slideOut","duration","isNil","err","warn","interval_marker","getAttribute","clearInterval","end_height","converse_disable_effects","step","interval","h","setInterval","setAttribute","add","fadeIn","isSameBareJID","jid1","jid2","getBareJidFromJid","toLowerCase","isNewMessage","message","Element","NS","MAM","isOTRMessage","body","querySelector","isNull","undefined","isHeadlineMessage","from_jid","merge","first","second","k","isObject","applyUserSettings","context","settings","user_settings","isArray","refreshWebkit","webkit","requestAnimationFrame","conversejs","getElementById","display","tmp","stringToDOM","s","childNodes","matchesSelector","selector","matches","msMatchesSelector","mozMatchesSelector","webkitMatchesSelector","oMatchesSelector","queryChildren","filter","contains","attr","query","item","value","TypeError","detectLocale","library_check","i","navigator","userLanguage","languages","browserLanguage","language","systemLanguage","isString","keys","isMomentLocale","getLocale","preferred_locale","isSupportedByLibrary","locale_data","converse","lang","e","error","isOfType","type","isInstance","key","not","createFragmentFromText","markup","frag","createDocumentFragment","firstChild","appendChild","addEmoji","_converse","emojione","use_emojione","toImage","shortnameToUnicode","getEmojisByCategory","emojis_by_category","emojis","values","mapValues","emojioneList","o","_shortname","tones","excluded","excluded_substrings","excluded_categories","categories","difference","uniq","cat","sortBy","concat","some","idx","findIndex","union","getTonedEmojis","toned_emojis","people","person","isPersistableModel","model","collection","browserStorage","getWrappedPromise","wrapper","promise","safeSave","attributes","save","set"],"mappings":"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","file":"utils.js","sourcesContent":["// Converse.js (A browser based XMPP chat client)\n// http://conversejs.org\n//\n// This is the utilities module.\n//\n// Copyright (c) 2012-2017, Jan-Carel Brand <jc@opkode.com>\n// Licensed under the Mozilla Public License (MPLv2)\n//\n/*global define, escape, locales, window, Jed */\n(function (root, factory) {\n    define([\n        \"sizzle\",\n        \"es6-promise\",\n        \"jquery.browser\",\n        \"lodash.noconflict\",\n        \"locales\",\n        \"moment_with_locales\",\n        \"strophe\",\n    ], factory);\n}(this, function (\n        sizzle,\n        Promise,\n        jQBrowser,\n        _,\n        locales,\n        moment,\n        Strophe\n    ) {\n    \"use strict\";\n    locales = locales || {};\n    const b64_sha1 = Strophe.SHA1.b64_sha1;\n    Strophe = Strophe.Strophe;\n\n    const URL_REGEX = /\\b(https?:\\/\\/|www\\.|https?:\\/\\/www\\.)[^\\s<>]{2,200}\\b/g;\n\n    const logger = _.assign({\n        'debug': _.get(console, 'log') ? console.log.bind(console) : _.noop,\n        'error': _.get(console, 'log') ? console.log.bind(console) : _.noop,\n        'info': _.get(console, 'log') ? console.log.bind(console) : _.noop,\n        'warn': _.get(console, 'log') ? console.log.bind(console) : _.noop\n    }, console);\n\n    var afterAnimationEnd = function (el, callback) {\n        el.classList.remove('visible');\n        if (_.isFunction(callback)) {\n            callback();\n        }\n    };\n\n    var unescapeHTML = function (htmlEscapedText) {\n        /* Helper method that replace HTML-escaped symbols with equivalent characters\n         * (e.g. transform occurrences of '&amp;' to '&')\n         *\n         * Parameters:\n         *  (String) htmlEscapedText: a String containing the HTML-escaped symbols.\n         */\n        var div = document.createElement('div');\n        div.innerHTML = htmlEscapedText;\n        return div.innerText;\n    };\n\n    var isImage = function (url) {\n        return new Promise((resolve, reject) => {\n            var img = new Image();\n            var timer = window.setTimeout(function () {\n                reject(new Error(\"Could not determine whether it's an image\"));\n                img = null;\n            }, 3000);\n            img.onerror = img.onabort = function () {\n                clearTimeout(timer);\n                reject(new Error(\"Could not determine whether it's an image\"));\n            };\n            img.onload = function () {\n                clearTimeout(timer);\n                resolve(img);\n            };\n            img.src = url;\n        });\n    };\n\n    function calculateSlideStep (height) {\n        if (height > 100) {\n            return 10;\n        } else if (height > 50) {\n            return 5;\n        } else {\n            return 1;\n        }\n    }\n\n    function calculateElementHeight (el) {\n        /* Return the height of the passed in DOM element,\n         * based on the heights of its children.\n         */\n        return _.reduce(\n            el.children,\n            (result, child) => result + child.offsetHeight, 0\n        );\n    }\n\n    function slideOutWrapup (el) {\n        /* Wrapup function for slideOut. */\n        el.removeAttribute('data-slider-marker');\n        el.classList.remove('collapsed');\n        el.style.overflow = \"\";\n        el.style.height = \"\";\n    }\n\n\n    var u = {};\n\n    // Translation machinery\n    // ---------------------\n    u.__ = function (str) {\n        if (_.isUndefined(window.Jed)) {\n            return str;\n        }\n        if (!u.isConverseLocale(this.locale) || this.locale === 'en') {\n            return Jed.sprintf.apply(window.Jed, arguments);\n        }\n        if (typeof this.jed === \"undefined\") {\n            this.jed = new Jed(window.JSON.parse(locales[this.locale]));\n        }\n        var t = this.jed.translate(str);\n        if (arguments.length>1) {\n            return t.fetch.apply(t, [].slice.call(arguments,1));\n        } else {\n            return t.fetch();\n        }\n    };\n\n    u.___ = function (str) {\n        /* XXX: This is part of a hack to get gettext to scan strings to be\n         * translated. Strings we cannot send to the function above because\n         * they require variable interpolation and we don't yet have the\n         * variables at scan time.\n         *\n         * See actionInfoMessages in src/converse-muc.js\n         */\n        return str;\n    };\n\n    u.isLocaleAvailable = function (locale, available) {\n        /* Check whether the locale or sub locale (e.g. en-US, en) is supported.\n         *\n         * Parameters:\n         *      (Function) available - returns a boolean indicating whether the locale is supported\n         */\n        if (available(locale)) {\n            return locale;\n        } else {\n            var sublocale = locale.split(\"-\")[0];\n            if (sublocale !== locale && available(sublocale)) {\n                return sublocale;\n            }\n        }\n    };\n\n    u.addHyperlinks = function (text) {\n        const list = text.match(URL_REGEX) || [];\n        var links = [];\n        _.each(list, (match) => {\n            const prot = match.indexOf('http://') === 0 || match.indexOf('https://') === 0 ? '' : 'http://';\n            const url = prot + encodeURI(decodeURI(match)).replace(/[!'()]/g, escape).replace(/\\*/g, \"%2A\");\n            const  a = '<a target=\"_blank\" rel=\"noopener\" href=\"' + url + '\">'+ _.escape(match) + '</a>';\n            // We first insert a hash of the code that will be inserted, and\n            // then later replace that with the code itself. That way we avoid\n            // issues when some matches are substrings of others.\n            links.push(a);\n            text = text.replace(match, b64_sha1(a));\n        });\n        while (links.length) {\n            const a = links.pop();\n            text = text.replace(b64_sha1(a), a);\n        }\n        return text;\n    };\n\n    u.renderImageURLs = function (obj) {\n        const list = obj.textContent.match(URL_REGEX) || [];\n        _.forEach(list, function (url) {\n            isImage(url).then(function (img) {\n                img.className = 'chat-image';\n                var anchors = sizzle(`a[href=\"${url}\"]`, obj);\n                _.each(anchors, (a) => { a.innerHTML = img.outerHTML; });\n            });\n        });\n        return obj;\n    };\n\n    u.slideInAllElements = function (elements) {\n        return Promise.all(\n            _.map(\n                elements,\n                _.partial(u.slideIn, _, 600)\n            ));\n    };\n\n    u.slideToggleElement = function (el) {\n        if (_.includes(el.classList, 'collapsed')) {\n            return u.slideOut(el);\n        } else {\n            return u.slideIn(el);\n        }\n    };\n\n    u.slideOut = function (el, duration=900) {\n        /* Shows/expands an element by sliding it out of itself\n         *\n         * Parameters:\n         *      (HTMLElement) el - The HTML string\n         *      (Number) duration - The duration amount in milliseconds\n         */\n        return new Promise((resolve, reject) => {\n            if (_.isNil(el)) {\n                const err = \"Undefined or null element passed into slideOut\"\n                logger.warn(err);\n                reject(new Error(err));\n                return;\n            }\n            let interval_marker = el.getAttribute('data-slider-marker');\n            if (interval_marker) {\n                el.removeAttribute('data-slider-marker');\n                window.clearInterval(interval_marker);\n            }\n            const end_height = calculateElementHeight(el);\n            if (window.converse_disable_effects) { // Effects are disabled (for tests)\n                el.style.height = end_height + 'px';\n                slideOutWrapup(el);\n                resolve();\n                return;\n            }\n\n            const step = calculateSlideStep(end_height),\n                  interval = end_height/duration*step;\n            let h = 0;\n\n            interval_marker = window.setInterval(function () {\n                h += step;\n                if (h < end_height) {\n                    el.style.height = h + 'px';\n                } else {\n                    // We recalculate the height to work around an apparent\n                    // browser bug where browsers don't know the correct\n                    // offsetHeight beforehand.\n                    el.style.height = calculateElementHeight(el) + 'px';\n                    window.clearInterval(interval_marker);\n                    slideOutWrapup(el);\n                    resolve();\n                }\n            }, interval);\n            el.setAttribute('data-slider-marker', interval_marker);\n        });\n    };\n\n    u.slideIn = function (el, duration=600) {\n        /* Hides/collapses an element by sliding it into itself. */\n        return new Promise((resolve, reject) => {\n            if (_.isNil(el)) {\n                const err = \"Undefined or null element passed into slideIn\";\n                logger.warn(err);\n                return reject(new Error(err));\n            } else if (_.includes(el.classList, 'collapsed')) {\n                return resolve();\n            } else if (window.converse_disable_effects) { // Effects are disabled (for tests)\n                el.classList.add('collapsed');\n                el.style.height = \"\";\n                return resolve();\n            }\n            let interval_marker = el.getAttribute('data-slider-marker');\n            if (interval_marker) {\n                el.removeAttribute('data-slider-marker');\n                window.clearInterval(interval_marker);\n            }\n            let h = el.offsetHeight;\n            const step = calculateSlideStep(h),\n                  interval = h/duration*step;\n\n            el.style.overflow = 'hidden';\n\n            interval_marker = window.setInterval(function () {\n                h -= step;\n                if (h > 0) {\n                    el.style.height = h + 'px';\n                } else {\n                    el.removeAttribute('data-slider-marker');\n                    window.clearInterval(interval_marker);\n                    el.classList.add('collapsed');\n                    el.style.height = \"\";\n                    resolve();\n                }\n            }, interval);\n            el.setAttribute('data-slider-marker', interval_marker);\n        });\n    };\n\n    u.fadeIn = function (el, callback) {\n        if (_.isNil(el)) {\n            logger.warn(\"Undefined or null element passed into fadeIn\");\n        }\n        if (window.converse_disable_effects) { // Effects are disabled (for tests)\n            el.classList.remove('hidden');\n            if (_.isFunction(callback)) {\n                callback();\n            }\n            return;\n        }\n        if (_.includes(el.classList, 'hidden')) {\n            /* XXX: This doesn't appear to be working...\n                el.addEventListener(\"webkitAnimationEnd\", _.partial(afterAnimationEnd, el, callback), false);\n                el.addEventListener(\"animationend\", _.partial(afterAnimationEnd, el, callback), false);\n            */\n            setTimeout(_.partial(afterAnimationEnd, el, callback), 351);\n            el.classList.add('visible');\n            el.classList.remove('hidden');\n        } else {\n            afterAnimationEnd(el, callback);\n        }\n    };\n\n    u.isSameBareJID = function (jid1, jid2) {\n        return Strophe.getBareJidFromJid(jid1).toLowerCase() ===\n                Strophe.getBareJidFromJid(jid2).toLowerCase();\n    };\n\n    u.isNewMessage = function (message) {\n        /* Given a stanza, determine whether it's a new\n         * message, i.e. not a MAM archived one.\n         */\n        if (message instanceof Element) {\n            return !(sizzle('result[xmlns=\"'+Strophe.NS.MAM+'\"]', message).length);\n        } else {\n            return !message.get('archive_id');\n        }\n    };\n\n    u.isOTRMessage = function (message) {\n        var body = message.querySelector('body'),\n            text = (!_.isNull(body) ? body.textContent: undefined);\n        return text && !!text.match(/^\\?OTR/);\n    };\n\n    u.isHeadlineMessage = function (message) {\n        var from_jid = message.getAttribute('from');\n        if (message.getAttribute('type') === 'headline') {\n            return true;\n        }\n        if (message.getAttribute('type') !== 'error' &&\n                !_.isNil(from_jid) &&\n                !_.includes(from_jid, '@')) {\n            // Some servers (I'm looking at you Prosody) don't set the message\n            // type to \"headline\" when sending server messages. For now we\n            // check if an @ signal is included, and if not, we assume it's\n            // a headline message.\n            return true;\n        }\n        return false;\n    };\n\n    u.merge = function merge (first, second) {\n        /* Merge the second object into the first one.\n         */\n        for (var k in second) {\n            if (_.isObject(first[k])) {\n                merge(first[k], second[k]);\n            } else {\n                first[k] = second[k];\n            }\n        }\n    };\n\n    u.applyUserSettings = function applyUserSettings (context, settings, user_settings) {\n        /* Configuration settings might be nested objects. We only want to\n         * add settings which are whitelisted.\n         */\n        for (var k in settings) {\n            if (_.isUndefined(user_settings[k])) {\n                continue;\n            }\n            if (_.isObject(settings[k]) && !_.isArray(settings[k])) {\n                applyUserSettings(context[k], settings[k], user_settings[k]);\n            } else {\n                context[k] = user_settings[k];\n            }\n        }\n    };\n\n    u.refreshWebkit = function () {\n        /* This works around a webkit bug. Refreshes the browser's viewport,\n         * otherwise chatboxes are not moved along when one is closed.\n         */\n        if (jQBrowser.webkit && window.requestAnimationFrame) {\n            window.requestAnimationFrame(function () {\n                var conversejs = document.getElementById('conversejs');\n                conversejs.style.display = 'none';\n                var tmp = conversejs.offsetHeight; // jshint ignore:line\n                conversejs.style.display = 'block';\n            });\n        }\n    };\n\n    u.stringToDOM = function (s) {\n        /* Converts an HTML string into a DOM element.\n         *\n         * Parameters:\n         *      (String) s - The HTML string\n         */\n        var div = document.createElement('div');\n        div.innerHTML = s;\n        return div.childNodes;\n    };\n\n    u.matchesSelector = function (el, selector) {\n        /* Checks whether the DOM element matches the given selector.\n         *\n         * Parameters:\n         *      (DOMElement) el - The DOM element\n         *      (String) selector - The selector\n         */\n        return (\n            el.matches ||\n            el.matchesSelector ||\n            el.msMatchesSelector ||\n            el.mozMatchesSelector ||\n            el.webkitMatchesSelector ||\n            el.oMatchesSelector\n        ).call(el, selector);\n    };\n\n    u.queryChildren = function (el, selector) {\n        /* Returns a list of children of the DOM element that match the\n         * selector.\n         *\n         *  Parameters:\n         *      (DOMElement) el - the DOM element\n         *      (String) selector - the selector they should be matched\n         *          against.\n         */\n        return _.filter(el.children, _.partial(u.matchesSelector, _, selector));\n    };\n\n    u.contains = function (attr, query) {\n        return function (item) {\n            if (typeof attr === 'object') {\n                var value = false;\n                _.forEach(attr, function (a) {\n                    value = value || _.includes(item.get(a).toLowerCase(), query.toLowerCase());\n                });\n                return value;\n            } else if (typeof attr === 'string') {\n                return _.includes(item.get(attr).toLowerCase(), query.toLowerCase());\n            } else {\n                throw new TypeError('contains: wrong attribute type. Must be string or array.');\n            }\n        };\n    };\n\n\n    u.detectLocale = function (library_check) {\n        /* Determine which locale is supported by the user's system as well\n         * as by the relevant library (e.g. converse.js or moment.js).\n         *\n         * Parameters:\n         *      (Function) library_check - returns a boolean indicating whether\n         *          the locale is supported.\n         */\n        var locale, i;\n        if (window.navigator.userLanguage) {\n            locale = u.isLocaleAvailable(window.navigator.userLanguage, library_check);\n        }\n        if (window.navigator.languages && !locale) {\n            for (i=0; i<window.navigator.languages.length && !locale; i++) {\n                locale = u.isLocaleAvailable(window.navigator.languages[i], library_check);\n            }\n        }\n        if (window.navigator.browserLanguage && !locale) {\n            locale = u.isLocaleAvailable(window.navigator.browserLanguage, library_check);\n        }\n        if (window.navigator.language && !locale) {\n            locale = u.isLocaleAvailable(window.navigator.language, library_check);\n        }\n        if (window.navigator.systemLanguage && !locale) {\n            locale = u.isLocaleAvailable(window.navigator.systemLanguage, library_check);\n        }\n        return locale || 'en';\n    };\n\n    u.isConverseLocale = function (locale) {\n        if (!_.isString(locale)) { return false; }\n        return _.includes(_.keys(locales || {}), locale);\n    };\n\n    u.isMomentLocale  = function (locale) {\n        if (!_.isString(locale)) { return false; }\n        return moment.locale() !== moment.locale(locale);\n    };\n\n    u.getLocale = function (preferred_locale, isSupportedByLibrary) {\n        if (_.isString(preferred_locale)) {\n            if (preferred_locale === 'en' || isSupportedByLibrary(preferred_locale)) {\n                return preferred_locale;\n            }\n            try {\n                var obj = window.JSON.parse(preferred_locale);\n                return obj.locale_data.converse[\"\"].lang;\n            } catch (e) {\n                logger.error(e);\n            }\n        }\n        return u.detectLocale(isSupportedByLibrary) || 'en';\n    };\n\n    u.isOfType = function (type, item) {\n        return item.get('type') == type;\n    };\n\n    u.isInstance = function (type, item) {\n        return item instanceof type;\n    };\n\n    u.getAttribute = function (key, item) {\n        return item.get(key);\n    };\n\n    u.contains.not = function (attr, query) {\n        return function (item) {\n            return !(u.contains(attr, query)(item));\n        };\n    };\n\n    u.createFragmentFromText = function (markup) {\n        /* Returns a DocumentFragment containing DOM nodes based on the\n         * passed-in markup text.\n         */\n        // http://stackoverflow.com/questions/9334645/create-node-from-markup-string\n        var frag = document.createDocumentFragment(),\n            tmp = document.createElement('body'), child;\n        tmp.innerHTML = markup;\n        // Append elements in a loop to a DocumentFragment, so that the\n        // browser does not re-render the document for each node.\n        while (child = tmp.firstChild) {  // eslint-disable-line no-cond-assign\n            frag.appendChild(child);\n        }\n        return frag\n    };\n\n    u.addEmoji = function (_converse, emojione, text) {\n        if (_converse.use_emojione) {\n            return emojione.toImage(text);\n        } else {\n            return emojione.shortnameToUnicode(text);\n        }\n    }\n\n    u.getEmojisByCategory = function (_converse, emojione) {\n        /* Return a dict of emojis with the categories as keys and\n         * lists of emojis in that category as values.\n         */\n        if (_.isUndefined(_converse.emojis_by_category)) {\n            const emojis = _.values(_.mapValues(emojione.emojioneList, function (value, key, o) {\n                value._shortname = key;\n                return value\n            }));\n            const tones = [':tone1:', ':tone2:', ':tone3:', ':tone4:', ':tone5:'];\n            const excluded = [':kiss_ww:', ':kiss_mm:', ':kiss_woman_man:'];\n            const excluded_substrings = [\n                ':woman', ':man', ':women_', ':men_', '_man_', '_woman_', '_woman:', '_man:'\n            ];\n            const excluded_categories = ['modifier', 'regional'];\n            const categories = _.difference(\n                _.uniq(_.map(emojis, _.partial(_.get, _, 'category'))),\n                excluded_categories\n            );\n            const emojis_by_category = {};\n            _.forEach(categories, (cat) => {\n                let list = _.sortBy(_.filter(emojis, ['category', cat]), ['uc_base']);\n                list = _.filter(\n                    list,\n                    (item) => !_.includes(_.concat(tones, excluded), item._shortname) &&\n                              !_.some(excluded_substrings, _.partial(_.includes, item._shortname))\n                );\n                if (cat === 'people') {\n                    const idx = _.findIndex(list, ['uc_base', '1f600']);\n                    list = _.union(_.slice(list, idx), _.slice(list, 0, idx+1));\n                } else if (cat === 'activity') {\n                    list = _.union(_.slice(list, 27-1), _.slice(list, 0, 27));\n                } else if (cat === 'objects') {\n                    list = _.union(_.slice(list, 24-1), _.slice(list, 0, 24));\n                } else if (cat === 'travel') {\n                    list = _.union(_.slice(list, 17-1), _.slice(list, 0, 17));\n                } else if (cat === 'symbols') {\n                    list = _.union(_.slice(list, 60-1), _.slice(list, 0, 60));\n                }\n                emojis_by_category[cat] = list;\n            });\n            _converse.emojis_by_category = emojis_by_category;\n        }\n        return _converse.emojis_by_category;\n    };\n\n    u.getTonedEmojis = function (_converse) {\n        _converse.toned_emojis = _.uniq(\n            _.map(\n                _.filter(\n                    u.getEmojisByCategory(_converse).people,\n                    (person) => _.includes(person._shortname, '_tone')\n                ),\n                (person) => person._shortname.replace(/_tone[1-5]/, '')\n            ));\n        return _converse.toned_emojis;\n    };\n\n    u.isPersistableModel = function (model) {\n        return model.collection && model.collection.browserStorage;\n    };\n\n    u.getWrappedPromise = function () {\n        const wrapper = {};\n        wrapper.promise = new Promise((resolve, reject) => {\n            wrapper.resolve = resolve;\n            wrapper.reject = reject;\n        })\n        return wrapper;\n    };\n\n    u.safeSave = function (model, attributes) {\n        if (u.isPersistableModel(model)) {\n            model.save(attributes);\n        } else {\n            model.set(attributes);\n        }\n    }\n    return u;\n}));\n"]}